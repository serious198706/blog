<!DOCTYPE html><html class="appearance-user-can-set" lang="zh"><head><meta charset="UTF-8"><title>Notex</title><meta name="description" content="Keep low profile, he said."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="åœ¨ Android ç³»ç»Ÿä¸­ï¼Œå››å¤§ç»„ä»¶ä¸­ï¼ŒService çš„é‡è¦æ€§ä¹Ÿæ˜¯ä¸è¨€è€Œå–»çš„ï¼Œå®ƒå¯ä»¥é•¿æ—¶é—´åœ¨åå°ç”Ÿå­˜ï¼Œæ‰§è¡Œä¸€äº›å¤æ‚çš„æˆ–è€…è€—æ—¶çš„å·¥ä½œã€‚å³ä¾¿ç”¨æˆ·åˆ‡æ¢åˆ°äº†å…¶ä»–åº”ç”¨ï¼ŒService ä»å°†åœ¨åå°ç»§ç»­è¿è¡Œã€‚æ­¤å¤–ï¼Œç»„ä»¶å¯é€šè¿‡ç»‘å®šåˆ° Service ä¸ä¹‹è¿›è¡Œäº¤äº’ï¼Œç”šè‡³æ˜¯æ‰§è¡Œè¿›ç¨‹é—´é€šä¿¡ (IPC)ã€‚


Service çš„åˆ†ç±»æˆ‘ä»¬ä¸€èˆ¬å°† Service åˆ†ä¸ºä¸‰å¤§ç±»ï¼šåå° Service ã€ç»‘å®š Service å’Œå‰å° Service ã€‚å…¶ä¸­ï¼Œåå° Service å’Œç»‘å®š Service æ˜¯ã€ä¸å¯è§ Serviceã€ï¼Œå‰å° Service æ˜¯ã€å¯è§ Serviceã€ã€‚
åå° Serviceåå° Service ï¼ˆBackground Serviceï¼‰ä¸€èˆ¬æ˜¯ç”¨æ¥æ‰§è¡Œä¸€äº›ç”¨æˆ·ä¸ä¼šç›´æ¥æ³¨æ„åˆ°çš„æ“ä½œï¼Œæ¯”å¦‚è§£å‹æ•°æ®åŒ…ï¼Œæ¯”å¦‚è¿›è¡Œç½‘ç»œè¯·æ±‚.."><script src="//unpkg.com/valine/dist/Valine.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><!-- a(href= url_for("/"))= (theme.user && theme.user.name || config.author) + "'s blog"--><a href="/">Notex</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">å…³äº Service</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">ä¸»é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">ä¸»é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text">Service çš„åˆ†ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0-Service"><span class="toc-text">åå° Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A-Service"><span class="toc-text">ç»‘å®š Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0-Service"><span class="toc-text">å‰å° Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8-Service"><span class="toc-text">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-%E7%9A%84%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-text">Service çš„é£Ÿç”¨æŒ‡å—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%86%E5%86%99%E6%96%B9%E6%B3%95"><span class="toc-text">è¦†å†™æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E-Service"><span class="toc-text">å£°æ˜ Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Service"><span class="toc-text">å¯åŠ¨ Service</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87startService-%E5%90%AF%E5%8A%A8%E7%9A%84-Service"><span class="toc-text">é€šè¿‡startService()å¯åŠ¨çš„ Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87bindService-%E5%90%AF%E5%8A%A8%E7%9A%84-Service"><span class="toc-text">é€šè¿‡bindService()å¯åŠ¨çš„ Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%89%8D%E5%8F%B0-Service"><span class="toc-text">å¯åŠ¨å‰å° Service</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IntentService"><span class="toc-text">IntentService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">Service çš„ç”Ÿå‘½å‘¨æœŸ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service%E8%AF%A6%E8%A7%A3"><span class="toc-text">Serviceè¯¦è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A-Service-%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-text">æ™®é€š Service çš„å¯åŠ¨è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A-Service-%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-text">ç»‘å®š Service çš„å¯åŠ¨è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IntentService-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-text">IntentService åŸç†è§£æ</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/Android"><i class="tag post-item-tag">Android</i></a><a href="/tags/Android%20Framework"><i class="tag post-item-tag">Android Framework</i></a><a href="/tags/Service"><i class="tag post-item-tag">Service</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">å…³äº Service</h1><time class="has-text-grey" datetime="2020-05-09T16:00:00.000Z">2020-05-10</time><article class="mt-2 post-content"><p>åœ¨ Android ç³»ç»Ÿä¸­ï¼Œå››å¤§ç»„ä»¶ä¸­ï¼ŒService çš„é‡è¦æ€§ä¹Ÿæ˜¯ä¸è¨€è€Œå–»çš„ï¼Œå®ƒå¯ä»¥é•¿æ—¶é—´åœ¨åå°ç”Ÿå­˜ï¼Œæ‰§è¡Œä¸€äº›å¤æ‚çš„æˆ–è€…è€—æ—¶çš„å·¥ä½œã€‚å³ä¾¿ç”¨æˆ·åˆ‡æ¢åˆ°äº†å…¶ä»–åº”ç”¨ï¼ŒService ä»å°†åœ¨åå°ç»§ç»­è¿è¡Œã€‚æ­¤å¤–ï¼Œç»„ä»¶å¯é€šè¿‡ç»‘å®šåˆ° Service ä¸ä¹‹è¿›è¡Œäº¤äº’ï¼Œç”šè‡³æ˜¯æ‰§è¡Œè¿›ç¨‹é—´é€šä¿¡ (IPC)ã€‚</p>
<span id="more"></span>

<h2 id="Service-çš„åˆ†ç±»"><a href="#Service-çš„åˆ†ç±»" class="headerlink" title="Service çš„åˆ†ç±»"></a>Service çš„åˆ†ç±»</h2><p>æˆ‘ä»¬ä¸€èˆ¬å°† Service åˆ†ä¸ºä¸‰å¤§ç±»ï¼šåå° Service ã€ç»‘å®š Service å’Œå‰å° Service ã€‚å…¶ä¸­ï¼Œåå° Service å’Œç»‘å®š Service æ˜¯ã€ä¸å¯è§ Serviceã€ï¼Œå‰å° Service æ˜¯ã€å¯è§ Serviceã€ã€‚</p>
<h3 id="åå°-Service"><a href="#åå°-Service" class="headerlink" title="åå° Service"></a>åå° Service</h3><p>åå° Service ï¼ˆBackground Serviceï¼‰ä¸€èˆ¬æ˜¯ç”¨æ¥æ‰§è¡Œä¸€äº›ç”¨æˆ·ä¸ä¼šç›´æ¥æ³¨æ„åˆ°çš„æ“ä½œï¼Œæ¯”å¦‚è§£å‹æ•°æ®åŒ…ï¼Œæ¯”å¦‚è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAPI 26ï¼ˆAndroid 8.0ï¼‰ä¹‹åï¼Œå¦‚æœåº”ç”¨æœ¬èº«æ²¡æœ‰åœ¨å‰å°è¿è¡Œï¼Œç³»ç»Ÿä¼šå¯¹åå°<strong>å¯æ‰§è¡Œçš„æ“ä½œå¢åŠ ä¸€äº›é™åˆ¶</strong>ã€‚è¿™äº›é™åˆ¶æœ‰ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ol>
<li><p><strong>åå° Service é™åˆ¶</strong>ã€‚è¿™äº›é™åˆ¶ä¸é€‚ç”¨äºå‰å° Serviceï¼Œå› ä¸ºå‰å° Service æ›´å®¹æ˜“å¼•èµ·ç”¨æˆ·æ³¨æ„ã€‚</p>
<p>åœ¨åå°è¿è¡Œçš„ Service ä¼šæ¶ˆè€—èµ„æºï¼Œè¿™æœ‰å¯èƒ½ä¼šé€ æˆä¸è‰¯çš„ç”¨æˆ·ä½“éªŒï¼Œæ‰€ä»¥ Android å¯¹åº”ç”¨çŠ¶æ€è¿›è¡Œäº†åŒºåˆ†ï¼š<strong>å‰å°åº”ç”¨</strong>å’Œ<strong>åå°åº”ç”¨</strong>ã€‚æ»¡è¶³ä¸‹é¢ä»»æ„æ¡ä»¶ï¼Œå³å¯è§†ä¸ºå‰å°åº”ç”¨ï¼š</p>
<ul>
<li>å…·æœ‰å¯è§çš„ Activity</li>
<li>å…·æœ‰å‰å° Service</li>
<li>å¦ä¸€ä¸ªå‰å°åº”ç”¨å·²å…³è”åˆ°è¯¥åº”ç”¨ï¼Œæ¯”å¦‚è¯´è¾“å…¥æ³•åœ¨åº”ç”¨ä¸­å¼¹å‡ºï¼Œåº”ç”¨æ­£åœ¨ä¸å±å¹•è¯†åˆ«å’Œè¯»å–åŠŸèƒ½äº¤äº’ç­‰ç­‰ã€‚</li>
</ul>
<p>å¦‚æœä¸Šé¢çš„æ¡ä»¶<strong>éƒ½ä¸æ»¡è¶³</strong>ï¼Œåº”ç”¨å°±ä¼šè¢«è§†ä¸º<strong>åå°åº”ç”¨</strong>ã€‚</p>
<p>å½“åº”ç”¨å¤„äºå‰å°æ—¶ï¼Œå¯ä»¥éšæ„åˆ›å»ºå’Œè¿è¡Œå‰å°ã€åå° Serviceã€‚å½“è¿›å…¥åå°æ—¶ï¼Œä¼šæœ‰å‡ åˆ†é’Ÿçš„æ—¶é—´ï¼Œåº”ç”¨ä»ç„¶å¯ä»¥åˆ›å»ºå’Œä½¿ç”¨ Serviceï¼Œè¿™ä¸ªæ—¶é—´ä¸€è¿‡ï¼Œåº”ç”¨å°±ä¼šè¢«è§†ä¸ºå¤„äº<strong>ç©ºé—²</strong>çŠ¶æ€ï¼Œè¿™æ—¶ï¼Œç³»ç»Ÿå°†<strong>åœæ­¢åº”ç”¨çš„åå° Service</strong>ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ JobScheduler æ¥å®Œæˆ Service èƒ½å®Œæˆçš„æ“ä½œã€‚å¯¹äº JobScheduler çš„è§£æï¼Œåœ¨<br><a href="/jobscheduler-and-workmanager/" target="_blank">è¿™ç¯‡æ–‡ç« é‡Œ</a>ã€‚</p>
</li>
<li><p><strong>å¹¿æ’­é™åˆ¶</strong>ã€‚é™¤äº†ä¸€äº›ç‰¹æ®Šçš„ä¾‹å¤–æƒ…å†µï¼Œåº”ç”¨<strong>æ— æ³•ä½¿ç”¨ AndroidManifest æ³¨å†Œéšå¼å¹¿æ’­</strong>ã€‚ä½†æ˜¯ä»ç„¶å¯ä»¥åœ¨è¿è¡Œæ—¶æ³¨å†Œå¹¿æ’­ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ AndroidManifest æ³¨å†Œ<strong>ä¸“é—¨é’ˆå¯¹å®ƒä»¬çš„æ˜¾å¼å¹¿æ’­</strong>ã€‚å…·ä½“çš„é™åˆ¶å¦‚ä¸‹ï¼š</p>
<ul>
<li>åº”ç”¨<strong>ä¸èƒ½åœ¨ AndroidManifest ä¸­ä¸ºéšå¼å¹¿æ’­æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨</strong>ã€‚ä¾‹å¦‚<code>ACTION_PACKAGE_REPLACED</code>å¹¿æ’­ã€‚æ˜¾å¼å¹¿æ’­ä¸å—å½±å“ã€‚</li>
<li>åº”ç”¨å¯ä»¥ä½¿ç”¨<code>Context.registerReceiver()</code>ä¸ºä»»æ„å¹¿æ’­ï¼ˆä¸ç®¡æ˜¯æ˜¾å¼è¿˜æ˜¯éšå¼ï¼‰æ³¨å†Œæ¥æ”¶å™¨ã€‚</li>
<li>éœ€è¦<strong>ç­¾åæƒé™çš„å¹¿æ’­ä¸å—æ­¤é™åˆ¶æ‰€é™</strong>ï¼Œå› ä¸ºè¿™äº›å¹¿æ’­åªä¼šå‘é€åˆ°ä½¿ç”¨ç›¸åŒè¯ä¹¦ç­¾åçš„åº”ç”¨ï¼Œè€Œä¸æ˜¯å‘é€åˆ°è®¾å¤‡ä¸Šçš„æ‰€æœ‰åº”ç”¨ã€‚</li>
</ul>
<p>åŒæ ·åœ°ï¼Œä¹‹å‰ä½¿ç”¨éšå¼å¹¿æ’­çš„åº”ç”¨ä¹Ÿå¯ä»¥ä½¿ç”¨ <strong>JobScheduler + åŠ¨æ€æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨</strong>æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p>
</li>
</ol>
<h3 id="ç»‘å®š-Service"><a href="#ç»‘å®š-Service" class="headerlink" title="ç»‘å®š Service"></a>ç»‘å®š Service</h3><p>å½“ç³»ç»Ÿç»„ä»¶ä¸ Service è¿›è¡Œç»‘å®šæ—¶ï¼Œ Service å°±å¤„äºã€<strong>ç»‘å®šçŠ¶æ€</strong>ã€ã€‚ç»‘å®š Service ä¼šä»¥ C/S æ¨¡å¼æä¾›æ¥å£ï¼Œä»¥ä¾¿ç»„ä»¶ä¸ Service è¿›è¡Œäº¤äº’ã€å‘é€è¯·æ±‚ã€æ¥æ”¶ç»“æœï¼Œç”šè‡³æ˜¯è·¨è¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚ç»‘å®š Service åªä¼š<strong>åœ¨ä¸æŸä¸ªç³»ç»Ÿç»„ä»¶ç»‘å®šæ—¶æ‰ä¼šè¿è¡Œ</strong>ã€‚å¤šä¸ªç»„ä»¶å¯åŒæ—¶ç»‘å®šåˆ°è¯¥ Service ï¼Œå…¨éƒ¨å–æ¶ˆç»‘å®šåï¼Œè¯¥ Service æ‰ä¼šè¢«é”€æ¯ã€‚</p>
<p>ä½†æ˜¯ï¼Œç»‘å®š Service å¹¶ä¸æ˜¯è¯´ä¸èƒ½ä»¥æ­£å¸¸çš„æ–¹å¼æ¥è¿è¡Œï¼Œä¸€ä¸ª Service ï¼Œå®ƒæ—¢å¯ä»¥æ˜¯å¯åŠ¨ Service ï¼ˆä»¥æ— é™æœŸè¿è¡Œï¼‰ï¼Œä¹ŸåŒæ—¶æ”¯æŒç»‘å®šï¼Œçœ‹ä½ è¦è¦†å†™å“ªç§æ–¹æ³•äº†ï¼š<code>onStartCommand()</code>æ˜¯è®©ç»„ä»¶æ¥å¯åŠ¨ Service åä¼šå›è°ƒçš„æ–¹æ³•ï¼Œè€Œ<code>onBind()</code>æ˜¯ä»¥ç»‘å®šæ–¹å¼å¯åŠ¨ Service åå›è°ƒçš„æ–¹æ³•ã€‚ä½†æ— è®ºæ˜¯å“ªç§ Service ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ Intent æ¥å¯åŠ¨å®ƒã€‚</p>
<h3 id="å‰å°-Service"><a href="#å‰å°-Service" class="headerlink" title="å‰å° Service"></a>å‰å° Service</h3><p>å‰å° Service ï¼ˆForeground Serviceï¼‰å¯ä»¥è¢«ç”¨æˆ·çœ‹åˆ°ã€‚é€šå¸¸å‰å° Service <strong>å¿…é¡»åœ¨é€šçŸ¥æ æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥</strong>ï¼Œæ¯”å¦‚å„ç§éŸ³ä¹ APPï¼š</p>
<p><img src="/img/service-1588775376.jpeg"></p>
<p>å³ä½¿ç”¨æˆ·åœæ­¢ä¸ App çš„äº¤äº’ï¼Œ Service ä¹Ÿä¾ç„¶ä¼šç»§ç»­è¿è¡Œã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-Service"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-Service" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Service"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Service</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨ Service æœ‰è¯¸å¤šé™åˆ¶ï¼Œè€Œä¸”è¿˜åˆ†ä»€ä¹ˆå‰å°åå°ç»‘å®šï¼Œ<strong>ç”¨å­çº¿ç¨‹å®ƒä¸é¦™å—ï¼Ÿ</strong></p>
<p>è¿™é‡Œè¦çœ‹ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>Service æ˜¯ä¸€ç§å³ä¾¿ç”¨æˆ·ä¸ä¸å®ƒäº¤äº’ï¼Œä¹Ÿèƒ½ä¸€ç›´è¿è¡Œåœ¨åå°çš„ç»„ä»¶ï¼Œå®ƒé»˜è®¤æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šçš„ã€‚å› æ­¤ï¼ŒService é€‚åˆ<strong>æ‰§è¡ŒçŸ­æœŸçš„ã€ä¸é˜»å¡çš„ã€ä¸ä¸ç”¨æˆ·äº¤äº’çš„ä»»åŠ¡</strong>ã€‚å¦‚æœä½ å¿…é¡»è¦åœ¨ä¸»çº¿ç¨‹ä¹‹å¤–æ‰§è¡Œä¸€äº›æ“ä½œï¼Œæ¯”å¦‚å¯†é›†æ€§çš„ç½‘ç»œé€šä¿¡ã€æ¯”å¦‚è¿›è¡Œå¤§é‡æ•°æ®çš„åˆå§‹åŒ–å’Œè§£æï¼Œé‚£ä½ æœ€å¥½è¿˜æ˜¯é€‰æ‹©åœ¨ Service ä¸­æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥åšè¿™ä»¶äº‹ã€‚</p>
<h2 id="Service-çš„é£Ÿç”¨æŒ‡å—"><a href="#Service-çš„é£Ÿç”¨æŒ‡å—" class="headerlink" title="Service çš„é£Ÿç”¨æŒ‡å—"></a>Service çš„é£Ÿç”¨æŒ‡å—</h2><h3 id="è¦†å†™æ–¹æ³•"><a href="#è¦†å†™æ–¹æ³•" class="headerlink" title="è¦†å†™æ–¹æ³•"></a>è¦†å†™æ–¹æ³•</h3><p>ä½¿ç”¨ Service çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»è¦è‡ªå®šä¹‰ä¸€ä¸ªç»§æ‰¿ Service çš„ç±»ï¼Œå¹¶è¦†å†™ä¸‹é¢å‡ ç§é‡è¦çš„æ–¹æ³•ï¼š</p>
<ul>
<li><p><code>onStartCommand(Intent intent, int flags, int startId)</code>ï¼š</p>
<p>å½“å¦ä¸€ä¸ªç»„ä»¶ï¼ˆå¦‚ Activityï¼‰è¯·æ±‚å¯åŠ¨ Service æ—¶ï¼Œä¸€èˆ¬ä¼šé€šè¿‡è°ƒç”¨<code>startService()</code>æ¥å¯åŠ¨ï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿä¼šæ‰§è¡Œ<code>onStartCommand()</code>æ–¹æ³•ï¼ˆå…·ä½“å¦‚ä½•è°ƒç”¨çš„ï¼ŒæŸ¥çœ‹<a href="#%E6%99%AE%E9%80%9A%20-Service-%20%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B">è¿™ä¸€ç« èŠ‚</a>ï¼‰ï¼Œå¦‚æœæ­¤æ—¶æœ‰ Intent ä¼ å…¥ï¼Œåˆ™å¯ä»¥è¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œ Service å·²ç»å¯åŠ¨äº†ã€‚å¦‚æœæ˜¯è¦è¦†å†™è¯¥æ–¹æ³•çš„è¯ï¼Œé‚£ä½ å¾—ä½¿ç”¨<code>stopSelf()</code>æˆ– <code>stopService()</code>æ¥åœæ­¢ Service ã€‚å¦‚æœåªæƒ³æä¾›ä¸€ä¸ªç»‘å®š Service ï¼Œåˆ™æ— éœ€è¦†å†™æ­¤æ–¹æ³•ã€‚</p>
<blockquote>
<p>ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œåœ¨è¦†å†™æ—¶ï¼Œè¿˜æœ‰ä¸ª<code>onStart()</code>æ–¹æ³•ï¼Œå¦‚æœæŸ¥çœ‹æºç çš„è¯ï¼Œåœ¨<code>onStartCommand()</code>ä¸­ç›´æ¥è°ƒç”¨äº†<code>onStart()</code>ã€‚è¯¥æ–¹æ³•åœ¨ Android 4.0.3ä¹‹åå°±è¢«åºŸå¼ƒäº†ï¼Œç°åœ¨éƒ½é‡‡ç”¨ç›´æ¥è¦†å†™<code>onStartCommand()</code>æ–¹æ³•äº†ã€‚</p>
</blockquote>
</li>
</ul>
<p>  å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª Intentï¼Œæ˜¯å¯åŠ¨ Service æ—¶ç»„ä»¶ä¼ é€’è¿‡æ¥çš„ Intentï¼Œå¯ä»¥ç”¨äºåˆå§‹åŒ–ã€‚<strong>è¿™ä¸ª Intent æœ‰å¯èƒ½ä¸º null</strong>ï¼Œå“ªæ€•ä½ æ˜æ˜ä¼ é€’äº†é null çš„ Intentã€‚å…·ä½“åŸå› åœ¨ä¸‹é¢ä¼šè®²åˆ°ã€‚</p>
<p>  å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª int å€¼ï¼Œæ˜¯å¯åŠ¨ Service æ—¶ç³»ç»Ÿç»™çš„é¢å¤–å‚æ•°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯0ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯<code>START_FLAT_REDELIVERY</code>ï¼ˆIntent ä¹‹å‰ä¼ é€’è¿‡ï¼‰å’Œ<code>START_FLAG_RETRY</code>ï¼ˆä¹‹å‰çš„ Intent æ²¡æœ‰æ­£ç¡®ä¼ é€’è¿‡æ¥ï¼Œé‡è¯•ä¼ é€’ï¼‰çš„<strong>æˆ–å€¼</strong>ã€‚</p>
<p>  å®ƒçš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ª int å€¼ï¼Œå«<code>startId</code>ï¼Œå®ƒç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€æ¬¡å¯åŠ¨è¯·æ±‚ï¼Œä¼šåœ¨<code>stopSelfResult(int)</code>è¿™ä¸ªæ–¹æ³•ä¸­ç”¨åˆ°è¿™ä¸ªå€¼ï¼Œç”¨ä»¥ç»ˆæ­¢å½“å‰ Serviceã€‚å®ƒå’Œ<code>stopService()</code>æ˜¯æœ‰åŒºåˆ«çš„ï¼Œ<code>stopService()</code>æ–¹æ³•ä¸€æ—¦è¢«è°ƒç”¨ï¼Œå°±ç›´æ¥ä¸€åˆ€ç æ­» Serviceï¼Œæ¯«ä¸ç•™æƒ…ï¼›ä½†<code>stopSelfResult()</code>ä¼šæ£€æŸ¥<code>startId</code>ï¼Œå¦‚æœåœ¨è°ƒç”¨<code>stopSelfResult()</code>çš„æ—¶å€™åˆæ¥äº†ä¸ªå¯åŠ¨çš„è¯·æ±‚ï¼Œæ­¤æ—¶<code>startId</code>å‘ç”Ÿäº†å˜åŒ–ï¼Œå®ƒå°±ä¼šå¤§å–Šä¸€å£°ã€åˆ€ä¸‹ç•™äºº~~~~ã€ï¼ŒService å°±ä¸ä¼šæ­»æ‰äº†ã€‚</p>
<p>  å®ƒçš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ª int å€¼ï¼Œæœ‰ä¸‹é¢å‡ ç§é€‰æ‹©ï¼š</p>
<ul>
<li><code>START_STICKY</code>ï¼šè¢«ç³»ç»Ÿæ¸…ç†åï¼Œä¼šä¿ç•™ Service çš„å¯åŠ¨çŠ¶æ€ï¼Œä½†ä¸ä¿ç•™ Intentï¼Œç³»ç»Ÿé‡å¯ Service åä¼šé‡æ–°è°ƒç”¨<code>onStartCommand()</code>æ–¹æ³•ï¼Œä½†å¦‚æœè¿™æœŸé—´æ²¡æœ‰æ”¶åˆ°ä»»ä½• Intentï¼Œé‚£ä¼ å…¥çš„ Intent å°±æ˜¯ nullï¼Œéœ€è¦å°å¿ƒå¤„ç†ã€‚</li>
<li><code>START_STICKY_COMPATIBILITY</code>ï¼š<code>START_STICKY</code> çš„å…¼å®¹ç‰ˆæœ¬ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯<code>onStartCommand()</code>ä¼šè¢«è°ƒç”¨ã€‚</li>
<li><code>START_NOT_STICKY</code>ï¼šè¢«ç³»ç»Ÿæ¸…ç†åï¼Œä¸ä¿ç•™ Service çŠ¶æ€ã€‚</li>
<li><code>START_REDELIVER_INTENT</code>ï¼šè¢«ç³»ç»Ÿæ¸…ç†åï¼Œä¼šä¿ç•™ Service çŠ¶æ€ï¼ŒåŒæ—¶ä¼šä¿ç•™ Intentï¼Œç³»ç»Ÿé‡å¯ Service åä¼šé‡æ–°è°ƒç”¨<code>onStartCommand()</code>æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šä¼ å…¥ä¹‹å‰ä¿ç•™çš„ Intentã€‚</li>
</ul>
<p>  é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>onStartCommand()</code>ä¼šè¿”å›<code>START_STICKY_COMPATIBILITY</code>æˆ–è€…<code>START_STICKY</code>ã€‚</p>
<ul>
<li><p><code>onBind(Intent intent)</code>ï¼š</p>
<p>å½“ä»¥ç»‘å®šæ–¹å¼å¯åŠ¨ Service æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼ˆå…·ä½“å¦‚ä½•è°ƒç”¨çš„ï¼ŒæŸ¥çœ‹<a href="##service-%E7%9A%84%E5%88%86%E7%B1%BB">è¿™ä¸€ç« èŠ‚</a>ï¼‰ï¼Œå¦‚æœæ­¤æ—¶æœ‰ Intent ä¼ å…¥ï¼Œåˆ™å¯ä»¥è¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œã€‚å¦‚æœè¦å®ç°ä¸ Client ç«¯é€šä¿¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å¿…é¡»è¦è¿”å›ä¸€ä¸ª IBinder çš„æ¥å£ï¼›å¦‚æœè¯¥ Service ä¸å¸Œæœ›ä¸ Client ç«¯é€šä¿¡ï¼Œå¯ä»¥ç›´æ¥è¿”å› nullã€‚</p>
</li>
<li><p><code>onCreate()</code>ï¼š</p>
<p>è¿™ä¸€çœ‹å°±æ˜¯ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨<code>onStartCommand()</code>å’Œ<code>onBind()</code>ä¹‹å‰è¢«è°ƒç”¨ã€‚å¦‚æœ Service å·²ç»åœ¨è¿è¡Œäº†ï¼Œè€Œå†æ¬¡å°è¯•å¯åŠ¨ Service çš„è¯ï¼Œè¿™ä¸ªæ–¹æ³•<strong>ä¸ä¼šå†è¢«è°ƒç”¨</strong>ã€‚</p>
</li>
<li><p><code>onDestroy()</code>ï¼š</p>
<p>ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•ï¼Œåœ¨ Service è¢«é”€æ¯ä¹‹å‰è°ƒç”¨ã€‚å¯ä»¥åœ¨è¿™é‡Œé¢åšä¸€äº›å›æ”¶çº¿ç¨‹ã€æ³¨é”€ BroadcastReceiver ä¹‹ç±»çš„å·¥ä½œã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒService åœ¨<strong>ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šè¢«é”€æ¯</strong>ï¼Œå¦‚æœè¿™ä¸ª Service æ˜¯å‰å° Service ï¼Œé‚£å®ƒ<strong>å‡ ä¹æ°¸è¿œä¸ä¼šç»ˆæ­¢</strong>ï¼ˆè¿è¡Œåœ¨æŸäº›å›½äº§OSä¸Šé™¤å¤–ï¼Œè¯´ç å°±ç æ²¡å¾—å•†é‡ğŸ”ªï¼‰ï¼›å¦‚æœ Service è¢«ç»‘å®šåˆ°å‰å° Activity ä¸Šï¼Œå®ƒä¹Ÿ<strong>ä¸å¤ªå¯èƒ½ä¼šç»ˆæ­¢</strong>ï¼›å¦‚æœç³»ç»Ÿåœ¨<strong>ä½å†…å­˜ä¸”å¿…é¡»å›æ”¶èµ„æºä»¥ä¿è¯å‰å° Activity ä¸ç”¨æˆ·çš„äº¤äº’</strong>çš„æƒ…å†µä¸‹ç»ˆæ­¢äº† Service ï¼Œé‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µç¼“è§£æ—¶ä¼š<strong>ç«‹å³é‡å¯ Service</strong> â€”â€”å½“ç„¶ï¼Œè¦çœ‹<code>onStartCommand()</code>ä¸­ä½ è¿”å›äº†ä¸ªå•¥ã€‚</p>
</li>
</ul>
<h3 id="å£°æ˜-Service"><a href="#å£°æ˜-Service" class="headerlink" title="å£°æ˜ Service"></a>å£°æ˜ Service</h3><p>å¦‚æœæƒ³è¦è¯¥ Service å¯ç”¨ï¼Œå¿…é¡»åœ¨ AndroidManifest ä¸­æ³¨å†Œè¿™ä¸ª Service ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="xml">&lt;manifest ...&gt;
  &lt;application ...&gt;
    &lt;service android:name=&quot;.CustomService&quot; /&gt;
  &lt;/application&gt;
&lt;/manifest&gt;
</code></pre>
<p>åœ¨<code>&lt;service&gt;</code>æ ‡ç­¾ä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å±æ€§å¯ä»¥è®¾ç½®ï¼Œæˆ‘ä»¬æ¥ä»‹ç»å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ã€‚</p>
<ul>
<li><code>android:name</code>ï¼šè¿™æ˜¯å”¯ä¸€å¿…éœ€çš„å±æ€§ï¼Œç”¨äº<strong>æŒ‡å®š Service çš„ç±»å</strong>ã€‚åœ¨ç»´æŠ¤ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œå°½é‡ä¿æŒè¿™ä¸ªç±»åä¸å˜ï¼Œä»¥é¿å…ä¸€äº›ç”¨<strong>æ˜¾å¼ Intent å¯åŠ¨ Service</strong> çš„ä»£ç ç¢°é’‰å­ã€‚</li>
</ul>
<blockquote>
<p><strong>æ˜¾å¼ Intent</strong></p>
<p>éšå¼ Intent æŒ‡çš„æ˜¯<strong>ä¸æŒ‡å®šç‰¹å®šå¤„ç†è€…</strong>çš„ Intentï¼Œè°éƒ½å¯ä»¥æ¥æ”¶å’Œå¤„ç†ï¼›è€Œ<strong>æ˜¾å¼ Intent æŒ‡å®šäº†æ¥æ”¶è€…</strong>ï¼Œé™¤äº†æŒ‡å®šçš„æ¥æ”¶è€…å¤–ï¼Œä»»ä½•åº”ç”¨éƒ½æ— æ³•æ¥æ”¶å’Œä½¿ç”¨è¿™ä¸ª Intentï¼Œä½¿å¾—åº”ç”¨æ›´åŠ å®‰å…¨ã€‚<br>ä» Android 5.0 å¼€å§‹ï¼Œå¦‚æœä½¿ç”¨éšå¼ Intent è°ƒç”¨<code>bindService()</code>ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š<br>java.lang.IllegalArgumentException: Service Intent must be explicit</p>
</blockquote>
<ul>
<li><p><code>android:enabled</code>ï¼šè¡¨ç¤ºç³»ç»Ÿæ˜¯å¦å¯ä»¥å®ä¾‹åŒ–è¯¥ Service ã€‚é»˜è®¤ä¸º<code>true</code>ï¼Œè¡¨ç¤ºå¯ä»¥ã€‚å¦‚æœè®¾ç½®äº†<code>false</code>ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨<code>PackageManager.setComponentEnabledSetting()</code>æ–¹æ³•åŠ¨æ€å¼€å¯ã€‚</p>
</li>
<li><p><code>android:exported</code>ï¼šè¡¨ç¤º<strong>å…¶ä»–çš„åº”ç”¨èƒ½å¦è°ƒç”¨è¯¥ Service æˆ–è€…ä¸ä¹‹äº¤äº’</strong>ã€‚è¯¥å±æ€§çš„é»˜è®¤å€¼å–å†³äºè¯¥ Service æ˜¯å¦åŒ…å« Intent Filterã€‚å¦‚æœæ²¡æœ‰ä»»ä½• Filter åˆ™è¡¨ç¤º Service åªèƒ½é€šè¿‡æŒ‡å®šç¡®åˆ‡çš„ç±»åæ¥è°ƒç”¨ï¼Œä¹Ÿæ„å‘³ç€è¯¥ Service æ˜¯ã€åº”ç”¨å†…éƒ¨ä¸“äº«ã€ï¼Œå› ä¸ºå…¶ä»–çš„åº”ç”¨ä¸çŸ¥é“å®ƒçš„ç±»åï¼ˆæ­£å¸¸æƒ…å†µä¸‹ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼æ˜¯<code>false</code>ï¼›åä¹‹å¦‚æœæœ‰ä»»æ„ä¸€ä¸ª Filter åˆ™è¡¨æ˜ Service å¯ä»¥ä¾›å¤–éƒ¨ä½¿ç”¨ï¼Œè¿™æ—¶é»˜è®¤å€¼æ˜¯<code>true</code>ã€‚</p>
<p>å¦å¤–ï¼Œè¦é™åˆ¶è¿™ä¸ª Service çš„æš´éœ²ï¼Œå°†è¯¥å­—æ®µè®¾ç½®ä¸º false å¹¶ä¸æ˜¯å”¯ä¸€çš„æ–¹å¼ã€‚è¿˜å¯ä»¥ä½¿ç”¨æƒé™æ§åˆ¶<code>android:permission</code>æ¥é™åˆ¶å“ªäº›å¤–éƒ¨åº”ç”¨å¯ä»¥ä¸ Service äº¤äº’ã€‚ä¸‹é¢ä¼šè®²åˆ°ã€‚</p>
</li>
<li><p><code>android:permission</code>ï¼šç»„ä»¶å¯åŠ¨ Service æˆ–ç»‘å®šåˆ° Service æ‰€å¿…éœ€çš„æƒé™çš„åç§°ã€‚å¦‚æœ<code>startService()</code>ã€<code>bindService()</code>æˆ–<code>stopService()</code>çš„è°ƒç”¨è€…<strong>å°šæœªè·å¾—æ­¤æƒé™</strong>ï¼Œé‚£è¯¥æ–¹æ³•å°†<strong>ä¸èµ·ä½œç”¨</strong>ï¼Œä¸”ç³»ç»Ÿä¸ä¼šå°† Intent å¯¹è±¡ä¼ é€ç»™ Service ï¼Œä¹Ÿå³æ— æ³•å®Œæˆäº¤äº’ã€‚<strong>å¦‚æœæœªè®¾ç½®è¯¥å±æ€§ï¼Œåˆ™ç³»ç»Ÿå°†ä¼šå°†å…¶è®¾ç½®ä¸º<code>&lt;application&gt;</code>æ ‡ç­¾ä¸­<code>permission</code>å±æ€§æ‰€è®¾ç½®çš„æƒé™</strong>ï¼ˆæ³¨æ„ï¼šä¸æ˜¯<code>&lt;uses-permisson&gt;</code>æ ‡ç­¾ï¼‰ã€‚å¦‚æœä¸¤ä¸ªå±æ€§éƒ½æ²¡è®¾ç½®ï¼Œåˆ™ Service ä¸å—æƒé™ä¿æŠ¤ã€‚</p>
</li>
<li><p><code>android:process</code>ï¼šå°†è¿è¡Œ Service çš„è¿›ç¨‹åç§°ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œåº”ç”¨çš„æ‰€æœ‰ç»„ä»¶éƒ½ä¼šåœ¨ä¸º<strong>åº”ç”¨åˆ›å»ºçš„é»˜è®¤è¿›ç¨‹</strong>ä¸­è¿è¡Œã€‚è¯¥åç§°ä¸<strong>åº”ç”¨åŒ…åç›¸åŒ</strong>ã€‚<code>&lt;application&gt;</code> å…ƒç´ çš„<code>process</code>å±æ€§å¯ä¸ºæ‰€æœ‰ç»„ä»¶è®¾ç½®é»˜è®¤è¿›ç¨‹åç§°ã€‚ä¸è¿‡ï¼Œç»„ä»¶å¯ä»¥ä½¿ç”¨è‡ªå·±çš„<code>process</code>å±æ€§æ›¿æ¢é»˜è®¤å€¼ï¼Œä»è€Œå°†åº”ç”¨æ•£å¸ƒåˆ°å¤šä¸ªè¿›ç¨‹ä¸­ã€‚</p>
<p>å¦‚æœä¸ºæ­¤å±æ€§åˆ†é…çš„åç§°<strong>ä»¥å†’å·<code>:</code>å¼€å¤´</strong>ï¼Œåˆ™ç³»ç»Ÿä¼š<strong>åœ¨éœ€è¦æ—¶åˆ›å»ºåº”ç”¨ä¸“ç”¨çš„æ–°è¿›ç¨‹</strong>ï¼Œå¹¶ä¸” Service ä¼š<strong>åœ¨è¯¥è¿›ç¨‹ä¸­è¿è¡Œ</strong>ã€‚å¦‚æœè¿›ç¨‹åç§°<strong>ä»¥å°å†™å­—ç¬¦å¼€å¤´</strong>ï¼Œåˆ™ Service å°†åœ¨<strong>ä½¿ç”¨è¯¥åç§°çš„å…¨å±€è¿›ç¨‹ä¸­è¿è¡Œï¼Œå‰ææ˜¯å®ƒæ‹¥æœ‰ç›¸åº”çš„æƒé™</strong>ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä¸åŒåº”ç”¨ä¸­çš„ç»„ä»¶ä¾¿å¯å…±äº«è¿›ç¨‹ï¼Œä»è€Œå‡å°‘èµ„æºä½¿ç”¨ã€‚</p>
</li>
</ul>
<h3 id="å¯åŠ¨-Service"><a href="#å¯åŠ¨-Service" class="headerlink" title="å¯åŠ¨ Service"></a>å¯åŠ¨ Service</h3><p>å¯åŠ¨ Service æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸Šé¢è®²è¿‡äº†ï¼Œ<code>startService()</code>å’Œ<code>bindService()</code>æ–¹æ³•ã€‚æˆ‘ä»¬è¿˜æ˜¯åˆ†å¼€æ¥è®²ã€‚</p>
<h4 id="é€šè¿‡startService-å¯åŠ¨çš„-Service"><a href="#é€šè¿‡startService-å¯åŠ¨çš„-Service" class="headerlink" title="é€šè¿‡startService()å¯åŠ¨çš„ Service"></a>é€šè¿‡<code>startService()</code>å¯åŠ¨çš„ Service</h4><pre><code class="java">Intent intent = new Intent(this, CustomService.class);
startService(intent);
</code></pre>
<p>è¿™ç§æ–¹å¼å¯åŠ¨ Service ï¼Œç³»ç»Ÿå°†ä¼šè°ƒç”¨<code>onStartCommand()</code>æ–¹æ³•ã€‚è¿™ç§ Service åœ¨å¯åŠ¨ä¹‹åï¼Œ<strong>å…¶ç”Ÿå‘½å‘¨æœŸå°†ç‹¬ç«‹äºå®ƒçš„å¯åŠ¨è€…</strong>ã€‚ä¾‹å¦‚ä¸€ä¸ª Activity é€šè¿‡è¿™ç§æ–¹å¼å¯åŠ¨äº† Service ï¼Œå“ªæ€• Activity ä¸å¯è§äº†ã€ç”šè‡³è¢«é”€æ¯äº†ï¼Œ Service ä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ Service å®Œæˆå·¥ä½œåï¼Œè°ƒç”¨å®ƒçš„<code>stopSelf()</code>æ¥åœæ­¢è¿è¡Œï¼Œæˆ–è€…ç”±å…¶ä»–çš„ç»„ä»¶è°ƒç”¨<code>stopService()</code>æ¥åœæ­¢è¯¥ Service ã€‚</p>
<p>åœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ª Intent å¯¹è±¡ç»™ Service ï¼Œ Service ä¼šåœ¨<code>onStartCommand()</code>ä¸­æ¥æ”¶åˆ°è¿™ä¸ª Intentã€‚å¤šæ¬¡é€šè¿‡è¿™ç§æ–¹å¼å¯åŠ¨ï¼Œä¼šå¤šæ¬¡è°ƒç”¨åˆ°<code>onStartCommand()</code>æ–¹æ³•ã€‚<strong>è¿™é€šå¸¸è¢«ç”¨æ¥å‘ Service ä¼ é€’æ•°æ®</strong>ã€‚</p>
<p>æ­¤å¤„å¿…é¡»å†å¼ºè°ƒä¸€æ¬¡ï¼Œ Service å¯åŠ¨åï¼Œ<strong>æ˜¯å·¥ä½œåœ¨ä¸»çº¿ç¨‹ä¸Šçš„</strong>ã€‚å¦‚æœäº¤ç»™ Service å»åšä¸€äº›å¯†é›†æ€§çš„ã€è€—æ—¶çš„ã€é˜»å¡çš„ä»»åŠ¡ï¼Œå¯èƒ½ä¼šå½±å“ Activity çš„æ€§èƒ½ã€‚å¦‚æœè¦ä½¿ç”¨ Service åšè¿™äº›äº‹ï¼Œä½ å¯ä»¥åœ¨ Service ä¸­æ–°å»ºçº¿ç¨‹æ¥åšè¿™äº›äº‹ã€‚</p>
<h4 id="é€šè¿‡bindService-å¯åŠ¨çš„-Service"><a href="#é€šè¿‡bindService-å¯åŠ¨çš„-Service" class="headerlink" title="é€šè¿‡bindService()å¯åŠ¨çš„ Service"></a>é€šè¿‡<code>bindService()</code>å¯åŠ¨çš„ Service</h4><pre><code class="java">ServiceConnection conn = new ServiceConnection() &#123;
    @Override
    public void onServiceConnected(ComponentName className,
                  IBinder service) &#123;
        LocalBinder binder = (LocalBinder) service;
        mService = binder.getService();
        mBound = true;
    &#125;

    @Override
    public void onServiceDisconnected(ComponentName arg0) &#123;
        mBound = false;
    &#125;
&#125;
Intent intent = new Intent(this, CustomService.class);
bindService(intent, conn, Context.BIND_AUTO_CREATE);
</code></pre>
<p>ç»„ä»¶å¯ä»¥é€šè¿‡ä¸Šè¿°æ–¹å¼ä¸ Service è¿›è¡Œé•¿æœŸç»‘å®šã€‚è¿™ç§ Service åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å…è®¸ç»„ä»¶é€šè¿‡è°ƒç”¨<code>startService()</code>æ–¹æ³•æ¥å¯åŠ¨å®ƒã€‚å®ƒé€šå¸¸åªåœ¨<strong>ä¸ºå…¶ä»–åº”ç”¨ç»„ä»¶æä¾›æœåŠ¡æ—¶</strong>å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶ä¸ä¼šæ— é™æœŸåœ°åœ¨åå°è¿è¡Œã€‚</p>
<p>è¿™ç§å¯åŠ¨æ–¹å¼å¤šç”¨åœ¨ä¸ Activity æˆ–è€…å…¶ä»–ç»„ä»¶çš„äº¤äº’ï¼Œä»¥åŠé€šè¿‡è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ä¸å…¶ä»–åº”ç”¨äº§ç”Ÿäº¤äº’ã€‚</p>
<p>ä¸€æ—¦ç»‘å®šï¼ŒService å°±ä¼šå¯åŠ¨ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ä»»ä½•ç»„ä»¶ä¸ Service æ˜¯ç»‘å®šçŠ¶æ€ï¼Œé‚£ Service <strong>å°±ä¼šè¢«ç³»ç»Ÿé”€æ¯</strong>ï¼Œæ‰€ä»¥ï¼Œå¯¹äºè¿™ç§ Service ï¼Œæˆ‘ä»¬**ä¸å¿…è°ƒç”¨<code>stopSelf()</code>æˆ–è€…<code>stopService()</code>**ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼ŒåŒä¸€ä¸ª Service å¯ä»¥<strong>åŒæ—¶è¢«å¤šä¸ªç»„ä»¶ç»‘å®š</strong>ã€‚</p>
<p>åœ¨ä»¥è¿™ç§æ–¹å¼ç»‘å®š Service æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨<code>onBind()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦<strong>è‡ªå·±å®ç°<code>onBind()</code>å›è°ƒæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª IBinder å¯¹è±¡ï¼Œä¾› Client æ¥ä¸ Service è¿›è¡Œäº¤äº’</strong>ã€‚å¤šæ¬¡ç»‘å®šåŒä¸€ä¸ª Service ï¼Œå¹¶ä¸ä¼šé‡å¤è°ƒç”¨<code>onBind()</code>æ–¹æ³•ï¼Œç³»ç»Ÿä¼šåœ¨ç¬¬ä¸€æ¬¡ç»‘å®šæ—¶ç”Ÿæˆ IBinder å¯¹è±¡ï¼Œå¹¶å¯¹å…¶è¿›è¡Œç¼“å­˜ï¼Œåœ¨ä¹‹åçš„ç»‘å®šä¸­ï¼Œç›´æ¥è¿”å›è¿™ä¸ªå¯¹è±¡ç»™ Clientã€‚</p>
<p>ServiceConnection ä¼šç›‘æ§ä¸ Service çš„è¿æ¥çŠ¶æ€ï¼Œå¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œå®ƒæœ‰ä¸¤ä¸ªéœ€è¦è¦†å†™çš„æ–¹æ³•ï¼š<code>onServiceConnected()</code>å’Œ<code>onServiceDisconnected()</code>ã€‚å‰è€…ä¼šä¼ é€’ä¸€ä¸ª IBinder å¯¹è±¡è¿›æ¥ï¼ŒClient è¿™æ—¶éœ€è¦<strong>å¼ºè½¬æˆè‡ªå·±éœ€è¦çš„ Binder å¯¹è±¡</strong>ï¼Œå¹¶å¯ä»¥è°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•ï¼Œå®Œæˆä¸ Service çš„é€šä¿¡ã€‚åè€…åˆ™æ˜¯<strong>ä¸ Service ä¸»åŠ¨è§£ç»‘æˆ–ä¸¢å¤±é“¾æ¥</strong>æ—¶çš„å›è°ƒã€‚</p>
<h4 id="å¯åŠ¨å‰å°-Service"><a href="#å¯åŠ¨å‰å°-Service" class="headerlink" title="å¯åŠ¨å‰å° Service"></a>å¯åŠ¨å‰å° Service</h4><p>ä¸Šé¢çš„ä¸¤ç§ Service éƒ½æ˜¯ã€åå° Service ã€ï¼Œæ¢è¨€ä¹‹ï¼Œå®ƒä»¬ä¸ä¼šè¢«ç”¨æˆ·å¯è§ã€‚å¦‚æœè¦å¯åŠ¨ç”¨æˆ·å¯è§çš„ã€å‰å° Service ã€ï¼Œéœ€è¦è°ƒç”¨<code>startForegroundService()</code>æ–¹æ³•ã€‚</p>
<pre><code class="java">Intent intent = new Intent(this, CustomService.class);
startForegroundService(intent);
</code></pre>
<p>ä½¿ç”¨è¿™ç§æ–¹æ³•å¯åŠ¨ Service ï¼Œå°±æ„å‘³ç€ Service åœ¨å¯åŠ¨ä¹‹åï¼Œå°±ä¼š<strong>ç«‹åˆ»è°ƒç”¨å®ƒçš„<code>startForeground(int, Notification)</code>æ–¹æ³•</strong>ï¼Œç”¨äºåœ¨é€šçŸ¥æ ä¸­åˆ›å»ºé€šçŸ¥ã€‚</p>
<pre><code class="java">final int ONGOING_NOTIFICATION_ID = 1;  // è¯¥å€¼ä¸å¯ä¸º0

Intent notificationIntent = new Intent(this, MainActivity.class);
PendingIntent pendingIntent =
        PendingIntent.getActivity(this, 0, notificationIntent, 0);

Notification notification =
          new Notification.Builder(this, CHANNEL_DEFAULT_IMPORTANCE)
    .setContentTitle(getText(R.string.notification_title))
    .setContentText(getText(R.string.notification_message))
    .setSmallIcon(R.drawable.icon)
    .setContentIntent(pendingIntent)
    .setTicker(getText(R.string.ticker_text))
    .build();

startForeground(ONGOING_NOTIFICATION_ID, notification);
</code></pre>
<p>ä½¿ç”¨å‰å° Service å¯ä»¥å˜ç›¸å®ç°ã€ä¿æ´»ã€ï¼Œå› ä¸ºç³»ç»Ÿå‡ ä¹ä¸ä¼šè€ƒè™‘å°†å®ƒåœæ­¢ï¼Œå“ªæ€•å†…å­˜ç©ºé—´ä¸è¶³ã€‚ä½†æ˜¯è¿™å¹¶ä¸ä»£è¡¨æˆ‘ä»¬å¯ä»¥æ»¥ç”¨å‰å° Service ï¼Œå› ä¸ºæ¯ä¸€ä¸ª Service éƒ½ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚</p>
<p>å¦‚æœè¦ç§»é™¤å‰å° Serviceï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>stopForeground(bool)</code>ï¼Œå‚æ•°è¡¨ç¤ºæ˜¯å¦è¦åŒæ—¶ç§»é™¤é€šçŸ¥æ çš„é€šçŸ¥ã€‚<strong>è¿™ä¸ªæ–¹æ³•ä¸ä¼šç»ˆæ­¢ Service</strong>ã€‚å¦‚æœä½¿ç”¨äº†<code>stopServie()</code>æ¥ç»ˆæ­¢ Serviceï¼Œé‚£ä¹ˆé€šçŸ¥æ ä¸­çš„é€šçŸ¥ä¹Ÿä¼šéšä¹‹è¢«ç§»é™¤ã€‚</p>
<h3 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h3><p>IntentService æ˜¯ Service çš„å­ç±»ï¼Œå®ƒåŒ…å«ä¸€ä¸ª HandlerThreadï¼Œè¿™æ„å‘³ç€å®ƒ<strong>å¹¶ä¸æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šå·¥ä½œ</strong>çš„ï¼Œå¯ä»¥å°†ä¸€äº›å…·æœ‰é¡ºåºæ€§çš„ã€ä¸éœ€è¦åŒæ—¶å¤„ç†çš„ä»»åŠ¡äº¤ç»™ IntentService æ¥å¤„ç†ã€‚</p>
<p>è¦ä½¿ç”¨è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°å®ƒçš„<code>onHandleIntent()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ¥æ”¶æ¯ä¸ªå¯åŠ¨è¯·æ±‚ä¸­çš„ Intentï¼Œå¹¶äº¤ç»™ HandlerThread å»å¤„ç†ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ IntentService æ—¶ï¼Œå¦‚æœä½ éœ€è¦é‡å†™<code>onStartCommand()</code>æ–¹æ³•ï¼Œåœ¨å¤„ç†å®Œè‡ªå·±çš„å·¥ä½œåï¼Œ<strong>å¿…é¡»è¦è°ƒç”¨<code>return super.onStartCommand()</code>æ–¹æ³•æ¥è¿”å›</strong>ï¼Œä»¥ä¿è¯åœ¨<code>onHandleIntent()</code>ä¸­èƒ½æ­£ç¡®æ¥æ”¶åˆ° Intentã€‚</p>
<p>IntentService åœ¨å¤„ç†å®Œæ‰€æœ‰è¯·æ±‚åä¼šåœæ­¢ Service ï¼Œæ‰€ä»¥ï¼Œ<strong>ä¸å¿…è°ƒç”¨<code>stopSelf()</code>æ–¹æ³•</strong>ã€‚</p>
<blockquote>
<p>IntentService åœ¨ API 30 ä¸­è¢«åºŸå¼ƒäº†ã€‚</p>
</blockquote>
<h2 id="Service-çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Service-çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Service çš„ç”Ÿå‘½å‘¨æœŸ"></a>Service çš„ç”Ÿå‘½å‘¨æœŸ</h2><p>ç›—ä¸ªå®˜ç½‘çš„å›¾ï¼Œç¾æ»‹å„¿æ»‹å„¿ï¼š</p>
<div class="center-img">

<p><img src="/img/service-1588840496.png"></p>
<p><em>å·¦è¾¹æ˜¯ä½¿ç”¨startService()è°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³è¾¹æ˜¯bindService()</em></p>
</div>

<p>å¯è§ï¼ŒService çš„ç”Ÿå‘½å‘¨æœŸå¾ˆç®€å•ï¼Œä¸ Activity ç›¸æ¯”ç®€ç›´æ˜¯å°å·«è§æ ¼æ ¼å·«ã€‚ä¸‹é¢çš„ä»£ç ï¼Œå°±å¯ä»¥ç›‘æ§ Service çš„æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸï¼š</p>
<pre><code class="java">public class CustomService extends Service &#123;
    int startMode;       // indicates how to behave if the service is killed
    IBinder binder;      // interface for clients that bind
    boolean allowRebind; // indicates whether onRebind should be used

    @Override
    public void onCreate() &#123;
        // Service åˆ›å»ºæ—¶å›è°ƒ
    &#125;

    @Override
    public int onStartCommand(Intent intent, int flags, int startId) &#123;
        // æœåŠ¡å·²å¯åŠ¨ï¼Œæ¯ä¸€æ¬¡ä½¿ç”¨ startService() å¯åŠ¨æœåŠ¡æ—¶å›è°ƒ
        return mStartMode;
    &#125;
    @Override
    public IBinder onBind(Intent intent) &#123;
        // ä¸€ä¸ª Client æ­£åœ¨å°è¯•è°ƒç”¨ bindService() ç»‘å®šè¯¥æœåŠ¡
        return mBinder;
    &#125;
    @Override
    public boolean onUnbind(Intent intent) &#123;
        // ä¸€ä¸ª Client æ­£åœ¨å°è¯•è°ƒç”¨ unbindService() ä¸è¯¥æœåŠ¡è§£ç»‘
        return mAllowRebind;
    &#125;
    @Override
    public void onRebind(Intent intent) &#123;
        // ä¸€ä¸ª Client åœ¨è§£ç»‘ååˆå°è¯•é‡æ–°ç»‘å®š
    &#125;
    @Override
    public void onDestroy() &#123;
        // Service é”€æ¯ä¹‹å‰å›è°ƒ
    &#125;
&#125;
</code></pre>
<p>çœ‹å‡ºæ¥äº†å—ï¼Ÿä¸ Activity ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯ï¼Œæ¯ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œ<strong>éƒ½ä¸éœ€è¦è°ƒç”¨è¶…ç±»çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</strong>ã€‚</p>
<h2 id="Serviceè¯¦è§£"><a href="#Serviceè¯¦è§£" class="headerlink" title="Serviceè¯¦è§£"></a>Serviceè¯¦è§£</h2><p>å¥½ï¼Œæ¥åˆ°è¿™ç¯‡æ–‡ç« æœ€æ ¸å¿ƒæœ€å¤æ‚çš„éƒ¨åˆ†äº†ã€‚æˆ‘ä»¬å…ˆæå‡ºå‡ ä¸ªé—®é¢˜ï¼Œç„¶åå¸¦ç€é—®é¢˜å»ç†è§£è¿™éƒ¨åˆ†ã€‚</p>
<blockquote>
<p>Service æ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿ</p>
<p>ä¼ é€’ç»™ Service çš„ Intent æ˜¯å¦‚ä½•äº¤åˆ° Service æ‰‹ä¸­çš„ï¼Ÿ</p>
<p>IntentService æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p>
</blockquote>
<p>æˆ‘ä»¬æ¥é€ä¸ªè§£é‡Šã€‚</p>
<h3 id="æ™®é€š-Service-çš„å¯åŠ¨è¿‡ç¨‹"><a href="#æ™®é€š-Service-çš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="æ™®é€š Service çš„å¯åŠ¨è¿‡ç¨‹"></a>æ™®é€š Service çš„å¯åŠ¨è¿‡ç¨‹</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¯åŠ¨ Service æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯<code>Context.startService()</code>ï¼Œæˆ‘ä»¬å°±ä»è¿™å„¿å…¥æ‰‹ï¼Œçœ‹çœ‹ Service çš„å¯åŠ¨è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼š</p>
<pre><code class="java">// android.content.Context.java

public abstract ComponentName startService(Intent service);
</code></pre>
<p>Service ç»§æ‰¿è‡ª ContextWrapperï¼Œæ‰€ä»¥</p>
<p>Context æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„ä¸»è¦å®ç°åœ¨ ContextImpl ç±»é‡Œï¼š</p>
<pre><code class="java">// android.app.ContextImpl.java

@Override
public ComponentName startService(Intent service) &#123;
    warnIfCallingFromSystemProcess(); // æ£€æŸ¥å½“å‰è¿›ç¨‹çš„ uid æ˜¯å¦ä¸ Process.SYSTEM_UID ç›¸ç­‰
    return startServiceCommon(service, false, mUser);
&#125;

private ComponentName startServiceCommon(Intent service, boolean requireForeground,
            UserHandle user) &#123;
        try &#123;
            validateServiceIntent(service);
            service.prepareToLeaveProcess(this);
            ComponentName cn = ActivityManager.getService().startService(
                mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(
                            getContentResolver()), requireForeground,
                            getOpPackageName(), user.getIdentifier());
            ...
            return cn;
        &#125; catch (RemoteException e) &#123;
            throw e.rethrowFromSystemServer();
        &#125;
    &#125;
</code></pre>
<p>ç”±ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒContext å°†å¯åŠ¨ Service çš„ä»»åŠ¡è½¬äº¤ç»™äº† ActivityManagerã€‚åŒæ—¶äº¤ç»™ ActivityManager çš„ï¼Œè¿˜æœ‰å½“å‰ App çš„ä¸»çº¿ç¨‹ã€‚è¿™é‡Œå¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆ Service å¯åŠ¨æ—¶ä¼šé»˜è®¤åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚</p>
<p>æœ‰äººè¦æ äº†ï¼šè¿™ä¸æ˜æ˜æ˜¯ Service å˜›ï¼Œä¸ºå•¥äº¤ç»™ ActivityManager æ¥å¯åŠ¨ï¼Ÿå…ˆåˆ«æ ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹æ·±å…¥ï¼š</p>
<pre><code class="java">// android.app.ActivityManager.java

public static IActivityManager getService() &#123;
    return IActivityManagerSingleton.get();
&#125;
</code></pre>
<p>è¿™é‡Œä½¿ç”¨å•ä¾‹æ¨¡å¼è¿”å›äº† IActivityManager çš„ Binder å¯¹è±¡ï¼Œä¹Ÿå³çœŸæ­£çš„<code>startService()</code>å·¥ä½œæ˜¯åœ¨ ActivityManagerService ä¸­å®Œæˆçš„ã€‚</p>
<pre><code class="java">// com.android.server.ActivityManagerService

public class ActivityManagerService extends IActivityManager.Stub
        implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;
    ...
    ActiveServices mServices;
    ...
    @Override
    public ComponentName startService(IApplicationThread caller, Intent service,
            String resolvedType, boolean requireForeground, String callingPackage, int userId)
            throws TransactionTooLargeException &#123;
        ...
        // ä½¿ç”¨ synchronized æ¥ä¿è¯åˆ›å»º Service æ—¶çš„çº¿ç¨‹å®‰å…¨
        synchronized(this) &#123;
            final int callingPid = Binder.getCallingPid();
            final int callingUid = Binder.getCallingUid();
            final long origId = Binder.clearCallingIdentity();
            ComponentName res;
            try &#123;
                res = mServices.startServiceLocked(caller, service,
                        resolvedType, callingPid, callingUid,
                        requireForeground, callingPackage, userId);
            &#125; finally &#123;
                Binder.restoreCallingIdentity(origId);
            &#125;
            return res;
        &#125;
    &#125;
    ...
&#125;
</code></pre>
<p>ç»§ç»­çœ‹<code>ActiveServices.startServiceLocked()</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">// com.android.server.am.ActiveServices.java

ComponentName startServiceLocked(IApplicationThread caller, Intent service, String resolvedType,
        int callingPid, int callingUid, boolean fgRequired, String callingPackage, final int userId)
        throws TransactionTooLargeException &#123;
    return startServiceLocked(caller, service, resolvedType, callingPid, callingUid, fgRequired,
            callingPackage, userId, false);
&#125;

ComponentName startServiceLocked(IApplicationThread caller, Intent service, String resolvedType,
        int callingPid, int callingUid, boolean fgRequired, String callingPackage,
        final int userId, boolean allowBackgroundActivityStarts)
        throws TransactionTooLargeException &#123;
    ...
    // å„ç§å¯åŠ¨å‰çš„æ£€æŸ¥ã€å¦‚ App æ˜¯å¦å­˜åœ¨ã€AndroidManifest ä¸­æ˜¯å¦æ³¨å†Œã€æƒé™æ˜¯å¦åˆç†
    ...
    // å°† Intent åŒ…è£…è¿›äº† ServiceRecord çš„æ–°å®ä¾‹ä¸­
    r.pendingStarts.add(new ServiceRecord.StartItem(r, false, r.makeNextStartId(),
              service, neededGrants, callingUid));
    if (fgRequired) &#123;
        // å‰å°æœåŠ¡å¯åŠ¨æˆåŠŸ
        ServiceState stracker = r.getTracker();
        if (stracker != null) &#123;
            stracker.setForeground(true, mAm.mProcessStats.getMemFactorLocked(),
                    r.lastActivity);
        &#125;
        mAm.mAppOpsService.startOperation(AppOpsManager.getToken(mAm.mAppOpsService),
                AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName, true);
    &#125;
    ...
    ComponentName cmp = startServiceInnerLocked(smap, service, r, callerFg, addToStarting);
    return cmp;
&#125;

ComponentName startServiceInnerLocked(ServiceMap smap, Intent service, ServiceRecord r,
        boolean callerFg, boolean addToStarting) throws TransactionTooLargeException &#123;
    ...
    // è®°å½•ä¸€æ¬¡è¿è¡Œï¼Œæ–¹ä¾¿ç³»ç»Ÿè®¡ç®—ç”µé‡ä¸è¿è¡Œæ—¶é—´çš„å…³ç³»
    synchronized (r.stats.getBatteryStats()) &#123;
        r.stats.startRunningLocked();
    &#125;
    String error = bringUpServiceLocked(r, service.getFlags(), callerFg, false, false);
    ...
    return r.name;
&#125;

private String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg,
        boolean whileRestarting, boolean permissionsReviewRequired)
        throws TransactionTooLargeException &#123;
    ...
    // è¿˜æ˜¯å„ç§æ£€æŸ¥

    // Service æ­£åœ¨è¢«å¯åŠ¨ï¼Œæ­¤æ—¶å®ƒä¸èƒ½è¢« force stop
    try &#123;
        AppGlobals.getPackageManager().setPackageStoppedState(
                r.packageName, false, r.userId);
    &#125; catch (RemoteException e) &#123;
    &#125; catch (IllegalArgumentException e) &#123;
        Slog.w(TAG, &quot;Failed trying to unstop package &quot;
                + r.packageName + &quot;: &quot; + e);
    &#125;

    ...
    ProcessRecord app;

    if (!isolated) &#123;
        app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false);

        if (app != null &amp;&amp; app.thread != null) &#123;
            try &#123;
                app.addPackage(r.appInfo.packageName, r.appInfo.longVersionCode, mAm.mProcessStats);
                // è¿™é‡Œå¼€å§‹å¯åŠ¨æœåŠ¡
                realStartServiceLocked(r, app, execInFg);
                return null;
            &#125; catch (TransactionTooLargeException e) &#123;
                throw e;
            &#125; catch (RemoteException e) &#123;
                Slog.w(TAG, &quot;Exception when starting service &quot; + r.shortInstanceName, e);
            &#125;

            // If a dead object exception was thrown -- fall through to
            // restart the application.
        &#125;
    &#125; else &#123;
        ...
    &#125;

    ...
    return null;
&#125;

private final void realStartServiceLocked(ServiceRecord r,
            ProcessRecord app, boolean execInFg) throws RemoteException &#123;
    ...
    // å¥½ç†Ÿæ‚‰çš„ä¸€å¥è¯ï¼Œåœ¨ AMS ä¸­ï¼Œä¹Ÿæ˜¯ä½¿ç”¨äº† ActivityThread ä¸­çš„ scheduleXXX æ¥å®ç°çš„åˆ›å»º Activity çš„åŠŸèƒ½
    app.thread.scheduleCreateService(r, r.serviceInfo,
            mAm.compatibilityInfoForPackage(r.serviceInfo.applicationInfo),
            app.getReportedProcState());
    ...
    // è¿™é‡Œå¼€å§‹å‘ Service å‘é€ Intentï¼Œä¹Ÿå³è°ƒç”¨ onStartCommand() æ–¹æ³•
    sendServiceArgsLocked(r, execInFg, true);
    ...
&#125;

private final void sendServiceArgsLocked(ServiceRecord r, boolean execInFg,
            boolean oomAdjusted) throws TransactionTooLargeException &#123;
    ...
    r.app.thread.scheduleServiceArgs(r, slice);
    ...
&#125;
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ AMS åˆ›å»º Activity çš„è¿‡ç¨‹å¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ ActivityThread æ¥å®Œæˆæœ€åçš„åˆ›å»ºå·¥ä½œï¼Œä¹‹å‰æ‰€æœ‰çš„æ£€æŸ¥å·¥ä½œï¼Œéƒ½æ˜¯ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼ŒåŒæ—¶è®°å½•ä¸€äº› Service çš„å¯åŠ¨ä¿¡æ¯ï¼Œä»¥ä¾¿è¿›è¡ŒåæœŸç®¡ç†ã€‚</p>
<p><code>scheduleCreateService()</code>å’Œ<code>scheduleCreateArgs()</code>åˆ†åˆ«å‘ ActivityThread ä¸­çš„ Handler å‘é€äº†<code>CREATE_SERVICE</code>å’Œ<code>SERVICE_ARGS</code>äº‹ä»¶ï¼Œå¹¶åˆ†åˆ«è°ƒç”¨åˆ°<code>handleCreateService()</code>å’Œ<code>handleServiceArgs((ServiceArgsData)msg.obj)</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">// android.app.ActivityThread.java

private void handleCreateService(CreateServiceData data) &#123;
    ...
    LoadedApk packageInfo = getPackageInfoNoCheck(
            data.info.applicationInfo, data.compatInfo);
    Service service = null;
    try &#123;
        // åˆ©ç”¨åå°„åˆ›å»º Service çš„å®ä¾‹
        java.lang.ClassLoader cl = packageInfo.getClassLoader();
        service = packageInfo.getAppFactory()
                .instantiateService(cl, data.info.name, data.intent);
    &#125; catch (Exception e) &#123;
        if (!mInstrumentation.onException(service, e)) &#123;
            throw new RuntimeException(
                &quot;Unable to instantiate service &quot; + data.info.name
                + &quot;: &quot; + e.toString(), e);
        &#125;
    &#125;

    try &#123;
        if (localLOGV) Slog.v(TAG, &quot;Creating service &quot; + data.info.name);

        ContextImpl context = ContextImpl.createAppContext(this, packageInfo);
        context.setOuterContext(service);

        Application app = packageInfo.makeApplication(false, mInstrumentation);
        service.attach(context, this, data.info.name, data.token, app,
                ActivityManager.getService());

        // è°ƒç”¨äº† Service çš„ onCreate ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
        service.onCreate();
        mServices.put(data.token, service);
        try &#123;
            ActivityManager.getService().serviceDoneExecuting(
                    data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);
        &#125; catch (RemoteException e) &#123;
            throw e.rethrowFromSystemServer();
        &#125;
    &#125; catch (Exception e) &#123;
        if (!mInstrumentation.onException(service, e)) &#123;
            throw new RuntimeException(
                &quot;Unable to create service &quot; + data.info.name
                + &quot;: &quot; + e.toString(), e);
        &#125;
    &#125;
&#125;

private void handleServiceArgs(ServiceArgsData data) &#123;
    Service s = mServices.get(data.token);
    if (s != null) &#123;
        try &#123;
            if (data.args != null) &#123;
                data.args.setExtrasClassLoader(s.getClassLoader());
                data.args.prepareToEnterProcess();
            &#125;
            int res;
            if (!data.taskRemoved) &#123;
                // è°ƒç”¨äº† onStartCommand ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
                res = s.onStartCommand(data.args, data.flags, data.startId);
            &#125; else &#123;
                s.onTaskRemoved(data.args);
                res = Service.START_TASK_REMOVED_COMPLETE;
            &#125;

            QueuedWork.waitToFinish();

            try &#123;
                ActivityManager.getService().serviceDoneExecuting(
                        data.token, SERVICE_DONE_EXECUTING_START, data.startId, res);
            &#125; catch (RemoteException e) &#123;
                throw e.rethrowFromSystemServer();
            &#125;
        &#125; catch (Exception e) &#123;
            if (!mInstrumentation.onException(s, e)) &#123;
                throw new RuntimeException(
                        &quot;Unable to start service &quot; + s
                        + &quot; with &quot; + data.args + &quot;: &quot; + e.toString(), e);
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<p>è‡³æ­¤ï¼ŒService å®Œæˆäº†åˆ›å»ºå’Œ Intent çš„ä¼ é€’ã€‚æˆ‘ä»¬ç”¨ä¸€å¼ æ—¶åºå›¾ï¼Œæ¥å±•ç¤ºæ•´ä¸ªè¿‡ç¨‹ï¼š</p>
<p><img src="/img/service-1588840496.png"></p>
<h3 id="ç»‘å®š-Service-çš„å¯åŠ¨è¿‡ç¨‹"><a href="#ç»‘å®š-Service-çš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="ç»‘å®š Service çš„å¯åŠ¨è¿‡ç¨‹"></a>ç»‘å®š Service çš„å¯åŠ¨è¿‡ç¨‹</h3><p>è¿˜æ˜¯ä»å…¥å£æ–¹æ³•<code>Context.bindService()</code>å¼€å§‹çœ‹ï¼š</p>
<pre><code class="java">// android.app.ContextImpl.java

@Override
public boolean bindService(Intent service, ServiceConnection conn, int flags) &#123;
    warnIfCallingFromSystemProcess(); // æ£€æŸ¥å½“å‰è¿›ç¨‹çš„ uid æ˜¯ä¸æ˜¯ Process.SYSTEM_UID
    return bindServiceCommon(service, conn, flags, null, mMainThread.getHandler(), null, getUser());
&#125;

private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags,
        String instanceName, Handler handler, Executor executor, UserHandle user) &#123;
    ...
    int res = ActivityManager.getService().bindIsolatedService(
        mMainThread.getApplicationThread(), getActivityToken(), service,
        service.resolveTypeIfNeeded(getContentResolver()),
        sd, flags, instanceName, getOpPackageName(), user.getIdentifier());
    ...
&#125;
</code></pre>
<p>ä¸ä¸Šé¢ç›¸åŒï¼Œè¿˜æ˜¯æ¥åˆ°äº† ActivityManagerService ä¸­ï¼Œçœç•¥éƒ¨åˆ†ä»£ç ï¼š</p>
<pre><code class="java">// com.android.server.ActivityManagerService

public class ActivityManagerService extends IActivityManager.Stub
        implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;
    ...
    ActiveServices mServices;
    ...
    public int bindIsolatedService(IApplicationThread caller, IBinder token, Intent service,
        String resolvedType, IServiceConnection connection, int flags, String instanceName,
        String callingPackage, int userId) throws TransactionTooLargeException &#123;
        ...
        synchronized(this) &#123;
            return mServices.bindServiceLocked(caller, token, service,
                resolvedType, connection, flags, instanceName, callingPackage, userId);
        &#125;
    &#125;
    ...
&#125;
</code></pre>
<p>è¿™é‡Œä¸æ™®é€š Service ä¸åŒçš„æ˜¯ï¼Œå®ƒæ²¡æœ‰è¿”å› ComponentNameï¼Œè€Œæ˜¯è¿”å›äº†ä¸€ä¸ª int å€¼ã€‚</p>
<pre><code class="java">// com.android.server.am.ActiveServices.java

int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service,
        String resolvedType, final IServiceConnection connection, int flags,
        String instanceName, String callingPackage, final int userId)
        throws TransactionTooLargeException &#123;
    ...
    // å„ç§æ£€æŸ¥
    ...

    // è¿™é‡Œæœ‰ä¸ªå¾ˆé‡è¦çš„æ“ä½œã€‚
    // å¦‚æœåœ¨åº”ç”¨çš„ä»»ä½•ç»„ä»¶è¿è¡Œä¹‹å‰ï¼Œéœ€è¦è®©ç”¨æˆ·æ£€æŸ¥æ˜¯å¦å¯ä»¥ç»™äºˆæƒé™ï¼Œè¿™æ—¶ä¼šå…ˆè®¡åˆ’ä¸€ä¸ªç»‘å®šæœåŠ¡ï¼Œä½†æ˜¯å¹¶ä¸å¯ç”¨å®ƒï¼Œ
    // ç„¶åå¯åŠ¨ review Activityï¼Œå¹¶ç»™å®ƒä¸€ä¸ª callbackï¼Œç”¨æˆ·äº¤äº’å®Œæˆåï¼Œå†å®ŒæˆæœåŠ¡çš„ç»‘å®šå·¥ä½œ
    if (mAm.getPackageManagerInternalLocked().isPermissionsReviewRequired(
            s.packageName, s.userId)) &#123;

        permissionsReviewRequired = true;

        final ServiceRecord serviceRecord = s;
        final Intent serviceIntent = service;

        RemoteCallback callback = new RemoteCallback(
                new RemoteCallback.OnResultListener() &#123;
            @Override
            public void onResult(Bundle result) &#123;
                synchronized(mAm) &#123;
                    final long identity = Binder.clearCallingIdentity();
                    try &#123;
                        if (!mPendingServices.contains(serviceRecord)) &#123;
                            return;
                        &#125;
                        // If there is still a pending record, then the service
                        // binding request is still valid, so hook them up. We
                        // proceed only if the caller cleared the review requirement
                        // otherwise we unbind because the user didn&#39;t approve.
                        if (!mAm.getPackageManagerInternalLocked()
                                .isPermissionsReviewRequired(
                                        serviceRecord.packageName,
                                        serviceRecord.userId)) &#123;
                            try &#123;
                                // ç”¨æˆ·é€šè¿‡äº†æƒé™éªŒè¯ï¼Œåˆ™åˆ›å»º Service å®ä¾‹
                                bringUpServiceLocked(serviceRecord,
                                        serviceIntent.getFlags(),
                                        callerFg, false, false);
                            &#125; catch (RemoteException e) &#123;
                                /* ignore - local call */
                            &#125;
                        &#125; else &#123;
                            unbindServiceLocked(connection);
                        &#125;
                    &#125; finally &#123;
                        Binder.restoreCallingIdentity(identity);
                    &#125;
                &#125;
            &#125;
        &#125;);

        final Intent intent = new Intent(Intent.ACTION_REVIEW_PERMISSIONS);
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                | Intent.FLAG_ACTIVITY_MULTIPLE_TASK
                | Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS);
        intent.putExtra(Intent.EXTRA_PACKAGE_NAME, s.packageName);
        intent.putExtra(Intent.EXTRA_REMOTE_CALLBACK, callback);

        mAm.mHandler.post(new Runnable() &#123;
            @Override
            public void run() &#123;
                mAm.mContext.startActivityAsUser(intent, new UserHandle(userId));
            &#125;
        &#125;);
    &#125;

    final long origId = Binder.clearCallingIdentity();

    try &#123;
        ...
        // å¦‚æœè¿™æ—¶ Service è¿˜æ²¡æœ‰è¢«åˆ›å»ºï¼Œåˆ™åˆ›å»º Service å®ä¾‹
        if ((flags&amp;Context.BIND_AUTO_CREATE) != 0) &#123;
            s.lastActivity = SystemClock.uptimeMillis();
            if (bringUpServiceLocked(s, service.getFlags(), callerFg, false,
                    permissionsReviewRequired) != null) &#123;
                return 0;
            &#125;
        &#125;
        ...
        if (s.app != null &amp;&amp; b.intent.received) &#123;
            // Service å·²ç»åœ¨è¿è¡Œäº†ï¼Œå°±å¯ä»¥ç›´æ¥è¿›è¡Œ connect
            // æ­¤å¤„çš„ connected æ˜¯ IServiceConnection.aidl ä¸­å®šä¹‰çš„ï¼Œè¿™ä¸ªæ–¹æ³•ç”± LoadedApk æ¥å®ç°ï¼Œå…·ä½“æŸ¥çœ‹ã€å…³äº Contextã€ä¸€æ–‡ï¼Œæ­¤å¤„ç•¥è¿‡
            // æœ€åä¼šè°ƒç”¨åˆ° ServiceConnection.onServiceConnected() æ–¹æ³•ï¼Œå®Œæˆäº†ç»‘å®šå·¥ä½œ
            try &#123;
                c.conn.connected(s.name, b.intent.binder, false);
            &#125; catch (Exception e) &#123;
                Slog.w(TAG, &quot;Failure sending service &quot; + s.shortInstanceName
                        + &quot; to connection &quot; + c.conn.asBinder()
                        + &quot; (in &quot; + c.binding.client.processName + &quot;)&quot;, e);
            &#125;

            // å¦‚æœæ˜¯é‡æ–°ç»‘å®š
            if (b.intent.apps.size() == 1 &amp;&amp; b.intent.doRebind) &#123;
                requestServiceBindingLocked(s, b.intent, callerFg, true);
            &#125;
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç»‘å®š
        &#125; else if (!b.intent.requested) &#123;
            requestServiceBindingLocked(s, b.intent, callerFg, false);
        &#125;

        getServiceMapLocked(s.userId).ensureNotStartingBackgroundLocked(s);

    &#125; finally &#123;
        Binder.restoreCallingIdentity(origId);
    &#125;

    return 1;
&#125;

private final boolean requestServiceBindingLocked(ServiceRecord r, IntentBindRecord i,
        boolean execInFg, boolean rebind) throws TransactionTooLargeException &#123;
    ...
    r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,
            r.app.getReportedProcState());
    ...
&#125;
</code></pre>
<p>ç»§ç»­äº¤ç»™ ActivityThread å»åšè¿™ä»¶äº‹ï¼Œç»è¿‡å‘é€<code>BIND_SERVICE</code>çš„æ¶ˆæ¯åï¼Œæ¥åˆ°äº†<code>ActivityThread.handleBindService()</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">// android.app.ActivityThread

private void handleBindService(BindServiceData data) &#123;
    Service s = mServices.get(data.token);

    if (s != null) &#123;
        try &#123;
            data.intent.setExtrasClassLoader(s.getClassLoader());
            data.intent.prepareToEnterProcess();
            try &#123;
                if (!data.rebind) &#123;
                    // è°ƒç”¨ Servcie å¯¹è±¡çš„ onBind ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
                    IBinder binder = s.onBind(data.intent);
                    ActivityManager.getService().publishService(
                            data.token, data.intent, binder);
                &#125; else &#123;
                    // è°ƒç”¨ Servcie å¯¹è±¡çš„ onRebind ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
                    s.onRebind(data.intent);
                    ActivityManager.getService().serviceDoneExecuting(
                            data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);
                &#125;
            &#125; catch (RemoteException ex) &#123;
                throw ex.rethrowFromSystemServer();
            &#125;
        &#125; catch (Exception e) &#123;
            if (!mInstrumentation.onException(s, e)) &#123;
                throw new RuntimeException(
                        &quot;Unable to bind to service &quot; + s
                        + &quot; with &quot; + data.intent + &quot;: &quot; + e.toString(), e);
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<p>åˆå›åˆ°äº† ActivityManagerService ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªæ–¹æ³•<code>publishService()</code>å’Œ<code>serviceDoneExecuting()</code>ã€‚è¿½è¸ªä¸‹å»ï¼Œå‘ç°<code>publishService()</code>æ–¹æ³•æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº† LoadedApk.connected() æ–¹æ³•ï¼›è€Œ<code>serviceDoneExecuting()</code>æ–¹æ³•å¹¶æ²¡æœ‰ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ rebind çš„æƒ…å†µä¸‹æ‰ä¼šè°ƒç”¨ï¼Œåˆšæ‰åœ¨ ActiveServices.bindServiceLocked å·²ç»é’ˆå¯¹ rebind æƒ…å†µè°ƒç”¨è¿‡ä¸€æ¬¡ LoadedApk.connected() äº†ã€‚</p>
<p>è‡³æ­¤ï¼Œç»‘å®š Service çš„å¯åŠ¨å®Œæˆã€‚</p>
<p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€å¼ æ—¶åºå›¾æ¥å±•ç¤ºä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<p><img src="/img/service-1588840496.png"></p>
<h3 id="IntentService-åŸç†è§£æ"><a href="#IntentService-åŸç†è§£æ" class="headerlink" title="IntentService åŸç†è§£æ"></a>IntentService åŸç†è§£æ</h3><p>IntentService çš„ç‰¹ç‚¹å°±ä¸å†èµ˜è¿°äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹å®ƒå…³é”®çš„ä»£ç ï¼Œç„¶åå†è§£é‡Šå®ƒçš„åŸç†ï¼š</p>
<pre><code class="java">public abstract class IntentService extends Service &#123;
    // æœ‰è‡ªå·±çš„ Looper
    private volatile Looper mServiceLooper;
    // æœ‰è‡ªå®šä¹‰çš„ Handler
    private volatile ServiceHandler mServiceHandler;
    private String mName;
    private boolean mRedelivery;

    // å°† Handler ç»‘å®šåˆ°åˆå§‹åŒ–çš„çº¿ç¨‹ä¸­
    private final class ServiceHandler extends Handler &#123;
        public ServiceHandler(Looper looper) &#123;
            super(looper);
        &#125;

        @Override
        public void handleMessage(Message msg) &#123;
            onHandleIntent((Intent)msg.obj);
            stopSelf(msg.arg1);
        &#125;
    &#125;

    // ä¼ å…¥ name ä»¥ä¾›å†…éƒ¨çš„ HandlerThread ä½¿ç”¨ï¼Œæ–¹ä¾¿è¿›è¡Œè°ƒè¯•
    public IntentService(String name) &#123;
        super();
        mName = name;
    &#125;

    // è®¾ç½® intent æ˜¯å¦ä¼šè¢«é‡æ–°ä¼ é€’
    //
    // å¦‚æœè®¾ç½®ä¸º trueï¼ŒonStartCommand() ä¼šè¿”å› Serivce.START_REDELIVER_INTENTï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ
    // å¦‚æœ onHandleIntent() è¿˜æ²¡æœ‰æ‰§è¡Œå®Œè¿”å›ï¼Œè¿›ç¨‹å°±æ­»æ‰äº†ï¼Œè¿™æ—¶è¿›ç¨‹ä¼šè¢«é‡å¯ç„¶åé‡æ–°ä¼ é€’åˆšæ‰çš„ intentã€‚
    // å¦‚æœä¹‹å‰å‘é€äº†å¤šä¸ª intent ï¼ˆå…¶ä»–çš„åœ¨ç­‰å¾…ï¼‰ï¼Œåªæœ‰æœ€è¿‘å‘é€çš„ä¸€ä¸ªèƒ½ä¿è¯è¢«é€è¾¾ï¼ˆå…¶ä»–çš„ä¸ä¸€å®šäº†ï¼‰ã€‚
    // 
    // å¦‚æœè®¾ç½®ä¸º false onStartCommand() ä¼šè¿”å› Serivce.START_NOT_STICKYï¼Œå¦‚æœè¿›è¡Œæ­»æ‰ï¼Œintent ä¹Ÿå°±éšé£æ¶ˆæ•£äº†
    //
    public void setIntentRedelivery(boolean enabled) &#123;
        mRedelivery = enabled;
    &#125;

    @Override
    public void onCreate() &#123;
        super.onCreate();
        // æ–°å»ºäº†ä¸€ä¸ªå±€éƒ¨çš„ HandlerThreadï¼Œä¹Ÿå³ä¸å…è®¸å¤–éƒ¨ç›´æ¥ç®¡ç†è¿™ä¸ªçº¿ç¨‹çš„çŠ¶æ€ã€‚
        HandlerThread thread = new HandlerThread(&quot;IntentService[&quot; + mName + &quot;]&quot;);
        thread.start();

        mServiceLooper = thread.getLooper();
        mServiceHandler = new ServiceHandler(mServiceLooper);
    &#125;

    @Override
    public void onStart(@Nullable Intent intent, int startId) &#123;
        Message msg = mServiceHandler.obtainMessage();
        msg.arg1 = startId;
        msg.obj = intent;
        mServiceHandler.sendMessage(msg);
    &#125;

    // ä¸è¦é‡å†™è¿™ä¸ªæ–¹æ³•
    @Override
    public int onStartCommand(@Nullable Intent intent, int flags, int startId) &#123;
        onStart(intent, startId);
        return mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;
    &#125;

    @Override
    public void onDestroy() &#123;
        mServiceLooper.quit();
    &#125;

    // é™¤éä½ éœ€è¦ç»‘å®šè¿™ä¸ªæœåŠ¡ï¼Œå¦åˆ™ä¸ç”¨é‡å†™è¿™ä¸ªæ–¹æ³•
    @Override
    @Nullable
    public IBinder onBind(Intent intent) &#123;
        return null;
    &#125;

    // å”¯ä¸€éœ€è¦é‡å†™çš„çš„æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå¯ä»¥å¤„ç†è°ƒç”¨è€…å‘é€æ¥çš„æ•°æ®
    @WorkerThread
    protected abstract void onHandleIntent(@Nullable Intent intent);
&#125;
</code></pre>
<p>å¯è§è¿™ä¸ªç±»å¹¶ä¸æ˜¯å¾ˆç¥ç§˜ï¼š</p>
<ol>
<li>ç»§æ‰¿äº† Service ç±»ï¼›</li>
<li>é‡å†™äº†<code>onCreate()</code>æ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå±€éƒ¨çš„ HandlerThreadï¼Œå¹¶ä¸å…è®¸å¤–éƒ¨ç›´æ¥è®¿é—®ï¼›</li>
<li>å®šä¹‰äº†ä¸€ä¸ª ServiceHandler å¹¶ä¸æ–°å»ºçš„ HandlerThread ç»‘å®šï¼›</li>
<li>é‡å†™äº†<code>onStart()</code>æ–¹æ³•ï¼Œåœ¨æ¯æ¬¡å¯åŠ¨æœåŠ¡è°ƒç”¨åˆ°<code>onStartCommand()</code>çš„æ—¶å€™ï¼Œè°ƒç”¨<code>onStart()</code>ï¼Œå¹¶å°†æ¶ˆæ¯ä¼ é€’ç»™ ServiceHandlerï¼›</li>
<li>å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³•<code>onHandleIntent(Intent)</code>ä¾›å­ç±»ä½¿ç”¨ï¼Œç”¨äºçœŸæ­£å¤„ç†è¯·æ±‚ã€‚</li>
</ol>
<p>è¿™ä¸ªç±»è™½ç„¶å¾ˆå¸¸ç”¨ï¼Œä½†æ˜¯ Google å†³å®šåœ¨ Android Rï¼ˆAndroid 11ï¼‰ä¸­ï¼Œå°†ä¼š<strong>åºŸå¼ƒè¿™ä¸ªç±»</strong>ï¼ŒåŸå› ä¸æœ€å¼€å§‹æåˆ°çš„ã€åå°æ“ä½œé™åˆ¶ã€ç›¸åŒï¼Œä¸€ä¸ªæ€»æ˜¯åœ¨åå°è¿è¡Œçš„æœåŠ¡ï¼Œå¿…ç„¶ä¼šé€ æˆèµ„æºçš„æ¶ˆè€—ä¸æµªè´¹ã€‚Android ç°åœ¨å¤§åŠ›æ¨å® çš„æ˜¯ androidx ä¸­çš„ <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/WorkManager.html">WorkManager</a> å’Œ <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/core/app/JobIntentService.html">JobIntentService</a>ï¼Œæˆ‘å°†ä¼šåœ¨å…¶ä»–çš„æ–‡ç« é‡Œè®²è§£ã€‚</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/Kotlin/2020-05-13-kotlin-coroutine/" title="Kotlin åç¨‹"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: Kotlin åç¨‹</span></a><a class="button is-default" href="/Android/JobScheduler/" title="JobScheduler å’Œ WorkManager"><span class="has-text-weight-semibold">Next: JobScheduler å’Œ WorkManager</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container" id="vcomments" data-comment_valine_id="b7rbKQnQFa9DYl1anYfacJRz-gzGzoHsz" data-comment_valine_key="nUuKvGHOJBRylruJLW2Fmekg"></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/serious198706"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright Â©</span><span> cy198706 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="äº¬ICPå¤‡2022033375å·" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">äº¬ICPå¤‡2022033375å· </a></p></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>